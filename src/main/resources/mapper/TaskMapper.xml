<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybaselectByUsernametiselectUsers.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.mapper.TaskMapper">
    <select id="taskList" resultType="com.project.entity.TaskList" >
        select a.task_id,a.type_id,b.dict_value as type_name,a.task_no,a.task_content,a.proj_id,a.proj_name,a.dept_name,a.maint_name
        ,a.task_time,a.step_code,c.dict_value as step_name from t_task_main a left join (select * from t_sys_dict where dict_unit='task'
        and dict_type='type') b on a.type_id=b.dict_code left join (select * from t_sys_dict where dict_unit='task' and dict_type='step') c
        on a.step_code=c.dict_code where 1=1
        <if test="params.deptName!=null and params.deptName!=''">
            and a.dept_name like '%' #{params.deptName} '%'
        </if>
        <if test="params.maintName!=null and params.maintName!=''">
            and a.maint_name like '%' #{params.maintName} '%'
        </if>
        <if test="params.stepCode!=null and params.stepCode!=''">
            and a.step_code = #{params.stepCode}
        </if>
        order by a.task_time desc
    </select>
    <select id="taskDet" resultType="com.project.entity.TaskDet">
        select task_id,type_id,task_title,task_no,proj_name,ass_ids,dept_name,task_content,maint_name,task_time,step_code from t_task_main where task_id = #{taskId}
    </select>
    <select id="taskAssList" resultType="com.project.entity.AssList">
        select t.ass_no,t.ass_name,t.ass_brand,t.ass_model,t.ass_net,t.ass_ipv4,a.unit_name as maint_name,t.maint_state,t.ass_state from t_ass_basic t
        left join t_sys_unit a on t.maint_id=a.unit_id where t.ass_id in (${assIds})
    </select>
    <select id="taskEventList" resultType="com.project.entity.EventList" >
        select t.event_id,t.ass_id,a.ass_name,t.event_type,t.event_content,t.event_time,t.event_source,t.event_state from t_ass_event t inner join t_ass_basic a
        on t.ass_id=a.ass_id where t.ass_id in (${assIds}) order by t.event_time desc
    </select>
    <delete id="deleteTask">
        delete from t_task_main where task_id=#{taskId}
    </delete>
    <update id="updateTask">
        update t_task_main set type_id=#{params.typeId},task_title=#{params.taskTitle},task_no=#{params.taskNo},task_content=#{params.taskContent}
        ,proj_name=#{params.projName},dept_name=#{params.deptName},maint_name=#{params.maintName},task_time=#{params.taskTime},step_code=#{params.stepCode}
        where task_id=#{params.taskId}
    </update>
    <insert id="insertTask2">
        insert into t_task_main(type_id,task_title,task_no,proj_name,dept_name,task_content,maint_name,task_time,step_code)
        values(#{params.typeId},#{params.taskTitle},#{params.taskNo},#{params.projName},#{params.deptName},#{params.taskContent}
        ,#{params.maintName},#{params.taskTime},#{params.stepCode})
    </insert>
</mapper>
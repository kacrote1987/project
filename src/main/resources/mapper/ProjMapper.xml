<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybaselectByUsernametiselectUsers.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.mapper.ProjMapper">
    <select id="selProjList" resultType="com.project.entity.ProjList" >
        select a.proj_id,a.proj_tag,a.proj_type,a.dept_name,a.proj_name,c.unit_name as unita_name,a.unita_manager,a.unita_tel
        ,d.unit_name as unitb_name,a.unitb_manager,a.unitb_tel,a.budget_amount,a.budget_percent,a.pay_percent
        ,b.dict_value as proj_stepcode FROM t_proj_main a left join (select dict_code,dict_value from t_sys_dict
        where dict_field='proj_stepcode') b on a.proj_stepcode=b.dict_code left join t_sys_unit c on a.unita_id=c.unit_id
        left join t_sys_unit d on a.unitb_id=d.unit_id where 1=1
        <if test="params.projTag!=null and params.projTag!=''">
            and a.proj_tag=#{params.projTag}
        </if>
        <if test="params.projType!=null and params.projType!=''">
            and a.proj_type=#{params.projType}
        </if>
        <if test="params.deptName!=null and params.deptName!=''">
            and a.dept_name like '%' #{params.deptName} '%'
        </if>
        <if test="params.projName!=null and params.projName!=''">
            and a.proj_name like '%' #{params.projName} '%'
        </if>
        <if test="params.unitaManager!=null and params.unitaManager!=''">
            and a.unita_manager like '%' #{params.unitaManager} '%'
        </if>
        <if test="params.projStepcode!=null and params.projStepcode!=''">
            and a.proj_stepcode = #{params.projStepcode}
        </if>
        order by a.proj_id
    </select>
    <select id="selProjDet" resultType="com.project.entity.ProjDet">
        select t.proj_id,t.proj_tag,t.proj_type,t.dept_name,t.proj_name,t.unita_id,a.unit_name as unita_name,t.unita_manager,t.unita_tel
        ,t.unitb_id,b.unit_name as unitb_name,t.unitb_manager,t.unitb_tel,t.budget_amount,t.budget_percent,t.pay_percent,t.remark,t.proj_stepcode
        FROM t_proj_main t left join t_sys_unit a on t.unita_id=a.unit_id left join t_sys_unit b on t.unitb_id=b.unit_id
        where t.proj_id=#{projId}
    </select>
    <insert id="insertProj">
        insert into t_proj_main(proj_tag,proj_type,dept_name,proj_name,dead_line,unita_name,unita_manager,unita_tel,unitb_name,unitb_manager,unitb_tel
        ,budget_amount,budget_percent,pay_percent,remark,proj_stepcode) values(#{params.projTag},#{params.projType},#{params.deptName},#{params.projName}
        ,#{params.deadLine},#{params.unitaName},#{params.unitaManager},#{params.unitaTel},#{params.unitbName},#{params.unitbManager},#{params.unitbTel}
        ,#{params.budgetAmount},#{params.budgetPercent},#{params.payPercent},#{params.remark},1)
    </insert>
    <delete id="deleteProj">
        delete from t_proj_main where proj_id=#{projId}
    </delete>
    <update id="updateProj">
        update t_proj_main set proj_tag=#{params.projTag},proj_type=#{params.projType},dept_name=#{params.deptName},proj_name=#{params.projName}
        ,dead_line=#{params.deadLine},unita_name=#{params.unitaName},unita_manager=#{params.unitaManager},unita_tel=#{params.unitaTel}
        ,unitb_name=#{params.unitbName},unitb_manager=#{params.unitbManager},unitb_tel=#{params.unitbTel},budget_amount=#{params.budgetAmount}
        ,budget_percent=#{params.budgetPercent},pay_percent=#{params.payPercent},remark=#{params.remark},proj_stepcode=#{params.projStepcode}
        where proj_id=#{params.projId}
    </update>
    <update id="projStep">
        update t_proj_main set proj_stepcode=proj_stepcode+#{stepVal} where proj_id=#{projId}
    </update>
    <update id="updateProjunit">
        update t_proj_main set ${type}=#{unitId} where proj_id=#{projId}
    </update>
    <select id="getAssTbl" resultType="string" >
        select CONCAT('t_ass_',ass_tbl) from t_proj_main where proj_id=#{projId}
    </select>
    <select id="assProj" resultType="com.project.entity.AssProj" >
        select (@rownum:=@rownum+1) as ass_id,t.* from (select @rownum:=0,camera_type as ass_type,camera_name as ass_name,camera_model as ass_model
        ,camera_code as factory_no,camera_brand as brand_name,camera_state as ass_state from t_ass_camera a where a.proj_id=#{projId}) t
    </select>
    <select id="projCost" resultType="com.project.entity.ProjCostForm" >
        select (@rownum:=@rownum+1) as ass_id,t.* from (select distinct @rownum:=0,camera_type as ass_type,camera_brand as brand_name,count(*) as ass_num
        from t_ass_camera where proj_id=#{projId} group by camera_type,camera_brand) t
    </select>
    <select id="meetList" resultType="com.project.entity.MeetListForm" >
        select meet_id,proj_id,meet_topic,meet_time,meet_addr,meet_host,meet_member from t_proj_meet where proj_id=#{params.projId}
<!--        <if test="params.meetTopic!=null and params.meetTopic!=''">-->
<!--            and meet_topic like '%' #{params.meetTopic} '%'-->
<!--        </if>-->
<!--        <if test="params.meetTime1!=null and params.meetTime1!=''">-->
<!--            and meet_time&gt;=#{params.meetTime1}-->
<!--        </if>-->
<!--        <if test="params.meetTime2!=null and params.meetTime2!=''">-->
<!--            and meet_time&lt;=#{params.meetTime2}-->
<!--        </if>-->
    </select>
    <select id="selGanttDet" resultType="com.project.entity.GanttDetForm" >
        select a.gantt_id,a.gantt_type,a.gantt_proce,a.gantt_time1,a.gantt_time2,a.total,a.sum
        FROM t_proj_gantt a where a.proj_id=#{projId}
    </select>
    <insert id="insertGantt">
        insert into t_proj_gantt(proj_id) values(#{projId})
    </insert>
    <delete id="deleteGantt">
        delete from t_proj_gantt where gantt_id=#{ganttId}
    </delete>
    <update id="updateGantt">
        update t_proj_gantt set ${field} = #{value} where gantt_id=#{ganttId}
    </update>
    <select id="selGanttDisp" resultType="com.project.entity.GanttDispForm" >
        select a.gantt_id as 'id',a.pid as 'pid',a.gantt_type as 'projectName',a.gantt_proce as 'projectElem'
        ,a.gantt_time1 as 'planStartAt',a.gantt_time2 as 'planEndAt',a.gantt_time1 as 'startAt',a.gantt_time2 as 'endAt'
        ,CONCAT(ROUND(a.sum/a.total*100,2),'%') as 'persent',datediff(a.gantt_time2,a.gantt_time1) as 'dur'
        ,a.total as 'total',a.sum as 'sum'
        FROM t_proj_gantt a where a.proj_id=#{projId}
    </select>
    <select id="docList" resultType="com.project.entity.DocListVo" >
        select a.doc_id,b.dict_value as type_name,a.doc_name,a.doc_puber,date(a.doc_time) as doc_time,a.doc_annex,a.doc_state
        from t_proj_doc_main a inner join (select * from t_sys_dict where dict_unit='doc') b on a.type_id=b.dict_code where 1=1
        <if test="params.typeId!=null and params.typeId!=''">
            and a.type_id=#{params.typeId}
        </if>
        <if test="params.docName!=null and params.docName!=''">
            and a.doc_name like '%' #{params.docName} '%'
        </if>
        <if test="params.docState!=null and params.docState!=''">
            and a.doc_state=#{params.docState}
        </if>
        order by a.type_id,a.doc_state desc,a.doc_time desc
    </select>
    <select id="docDet" resultType="com.project.entity.DocList">
        select t.doc_id,t.type_id,a.dict_value as type_name,t.doc_name,t.doc_content,t.doc_puber,t.doc_time,t.doc_annex,t.doc_state from t_proj_doc_main t
        left join (select * from t_sys_dict where dict_unit='doc') a on t.type_id=a.dict_code where t.doc_id=#{docId}
    </select>
</mapper>